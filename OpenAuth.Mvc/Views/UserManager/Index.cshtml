@using System.Text
@{
    string _prefix = "user";
    var _treeId = _prefix + "Tree";
    var _gridId = _prefix + "Grid";
    var _treeDetail = _prefix + "Detail";
}
<div class="bjui-pageHeader">
    <div class="bjui-searchBar">
        <div class="bjui-searchBar">
            @*<label>名称：</label><input type="text" value="" name="code" size="10">&nbsp;
            <button type="submit" class="btn-default" data-icon="search">查询</button>&nbsp;
            <a class="btn btn-orange" href="javascript:;" data-toggle="reloadsearch" data-clear-query="true" data-icon="undo">
                清空查询
            </a></li>*@
            <div class="pull-right">
                @{
                    var sb = new StringBuilder();
                    foreach (var element in ViewBag.Module.Elements)
                    {
                        sb.Append("<" + element.Type
                                  + " data-icon='" + element.Icon + "' "
                                  + " class='" + element.Class + "' "
                                  + " onclick='" + element.Script + "' " + element.Attr
                                  + ">" + element.Name + "</" + element.Type + ">");
                    }
                    @Html.Raw(sb.ToString())
                }
            </div>


        </div>
    </div>
</div>

<div class="bjui-pageContent tableContent">
    <div class="clearfix">
        <div style="float: left; width: 220px; overflow: auto;" class="table table-bordered">
            <ul id="@_treeId" class="ztree"></ul>
        </div>

      
        <div id="@_treeDetail" style="margin-left: 225px;">
        </div>
    </div>
</div>

<script type="text/javascript">
    var gridid = '#@_gridId';
    var selectedId = 0;
    var grid;
    $(document).ready(function () {
        initZtree();
        loadDataGrid();
    });
    //加载数据到datagrid
    function loadDataGrid() {
        //b-jui的datagrid需要重新处理HTML
        $('#@_treeDetail').empty()
            .append('<table id="@_gridId" class="table table-bordered table-hover table-striped table-top"></table>');

        grid = $(gridid).datagrid({
            showToolbar: false,
            filterThead: false,
            columns: [
                {
                    name: 'Id',
                    label: 'Id',
                    attrs: { readonly: 'readonly' },
                    hide: true
                },
                {
                    name: 'Account',
                    label: '用户账号',
                    width: 142,
                    attrs: { readonly: 'readonly' }
                },
                {
                    name: 'Name',
                    label: '姓名/昵称',
                    width: 226
                },
                {
                    name: 'Organizations',
                    label: '所属机构',
                    width: 150
                },
                {
                    name: 'Status',
                    label: '状态',
                    type: 'select',
                    align: 'center',
                    width: 80,
                    items: [{ '0': '正常' }, { '1': '禁用' }]
                },
                {
                    name: 'Sex',
                    label: '性别',
                    type: 'select',
                    align: 'center',
                    width: 80,
                    items: [{ '0': '男' }, { '1': '女' }]
                },
                {
                    name: 'CreateTime',
                    label: '登记日期',
                    type: 'date',
                    width: 180,
                    pattern: 'yyyy-MM-dd HH:mm:ss'
                }
            ],
            dataUrl: 'UserManager/Load?orgId=' + selectedId,
            fullGrid: true,
            showLinenumber: true,
            showCheckboxcol: true,
            paging: true,
            filterMult: false,
            showTfoot: true,
            height: '700'
        });
    }

    function zTreeOnClick(event, treeId, treeNode) {
        selectedId = treeNode.Id;
        loadDataGrid();
    }

    function initZtree() {
        var setting = {
            view: { selectedMulti: false },
            data: {
                key: {
                    name: 'Name',
                    title: 'Name'
                },
                simpleData: {
                    enable: true,
                    idKey: 'Id',
                    pIdKey: 'ParentId',
                    rootPId: 'null'
                }
            },
            callback: { onClick: zTreeOnClick }
        };
        $.getJSON('OrgManager/LoadOrg', function (json) {
            var zTreeObj = $.fn.zTree.init($('#@_treeId'), setting, json);
            zTreeObj.expandAll(true);
        });
    }

    //获取勾选的值
    //column:为从0开始的列标识
    function getSelected(column) {
        var selected = $(gridid).data('selectedTrs');
        if (selected == null || selected.length == 0) {
            $(this).alertmsg('warn', '至少选择一个对象', {
                displayMode: 'slide',
                title: '重要提示'
            });
            return null;
        }

        //todo：下面这段只能chrome有效
        var records = new Array();
        selected.each(function () {
            records[records.length] = this.children[column].innerText;
        });

        return records[0];
    }

    //删除
    function del() {
        var selected = getSelected(2);
        if (selected == null) return;
        
        $.getJSON('UserManager/Delete?Id=' + selected, function (data) {
            if (data.statusCode == "200")
                refreshGrid();
            else {
                $(this).alertmsg('warn', data.message);
            }
        });
    }

    //自定义的编辑按钮
    function editOrg() {
        var selected = getSelected(2);
        if (selected == null) return;

        $(this).dialog({
            id: 'editDialog',
            url: '/UserManager/Add?id=' + selected,
            title: '编辑',
            onClose: function () {
                refreshGrid();
            }
        });

    }

    function refreshGrid() {
        $('#@_gridId').datagrid('refresh');
    }

    //用户模块授权按钮
    function openModuleAccess(obj) {

        var selected = getSelected(2);
        if (selected == null) return;

        $(obj).dialog({
            id: 'accessUserModule',
            url: '/ModuleManager/LookupMultiForUser',
            title: '为用户分配模块',
            data: {
                userId: selected
            }
        });
    }

    //用户角色授权
    function openRoleAccess(obj) {
        var selected = getSelected(2);
        if (selected == null) return;

        $(obj).dialog({
            id: 'accessUserRole',
            url: '/RoleManager/LookupMulti',
            title: '为用户分配角色',
            data: {
                userId: selected
            }
        });
    }
    //@@ sourceURL=userManagerIndex.js
</script>